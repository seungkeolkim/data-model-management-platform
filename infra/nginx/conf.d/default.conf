server {
    listen 80;
    server_name _;

    client_max_body_size 100m;

    # -------------------------------------------------------------------------
    # /api/* → FastAPI 백엔드
    # -------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 300s;  # 파이프라인 실행 시 긴 요청 허용
    }

    # -------------------------------------------------------------------------
    # /health → FastAPI 헬스체크
    # -------------------------------------------------------------------------
    location /health {
        proxy_pass http://backend:8000/health;
        proxy_set_header Host $host;
    }

    # -------------------------------------------------------------------------
    # /openapi.json → FastAPI OpenAPI 스펙 (Swagger UI가 root-relative로 요청)
    # -------------------------------------------------------------------------
    location /openapi.json {
        proxy_pass http://backend:8000/openapi.json;
        proxy_set_header Host $host;
    }

    # -------------------------------------------------------------------------
    # /static/datasets/* → NAS 데이터셋 파일 직접 서빙 (샘플 이미지)
    # -------------------------------------------------------------------------
    location /static/datasets/ {
        alias /mnt/datasets/;
        # 이미지 파일만 허용
        location ~* \.(jpg|jpeg|png|bmp|tiff|tif|webp)$ {
            expires 1d;
            add_header Cache-Control "public, immutable";
        }
        # 다른 파일 접근 차단
        location ~* \.(json|txt|csv|xml)$ {
            return 403;
        }
    }

    # -------------------------------------------------------------------------
    # /static/eda/* → EDA 결과 이미지
    # -------------------------------------------------------------------------
    location /static/eda/ {
        alias /mnt/eda/;
        expires 5m;
    }

    # -------------------------------------------------------------------------
    # /* → React 프론트엔드 (개발: vite dev server, 운영: static files)
    # -------------------------------------------------------------------------
    location / {
        proxy_pass http://frontend:5173;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_http_version 1.1;
        # Vite HMR WebSocket
        proxy_read_timeout 86400s;
    }
}
